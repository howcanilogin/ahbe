<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kripto Destekli GeliÅŸmiÅŸ YatÄ±rÄ±m HesaplayÄ±cÄ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    .loader { border: 2px solid #f3f3f3; border-top: 2px solid #4f46e5; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .custom-checkbox:checked { background-color: #4f46e5; border-color: #4f46e5; }
    .custom-checkbox:checked::after { content: 'âœ“'; color: white; display: block; text-align: center; line-height: 1.25rem; font-size: 0.8rem; }
    .best-performer { background-color: #f0fdf4; border-left: 4px solid #22c55e; }
    .chart-container { height: 360px; width: 100%; }
    .muted { color: #6b7280; font-size: 0.85rem; }
    .asset-logo { width: 24px; height: 18px; border-radius: 3px; object-fit: cover; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .crypto-logo, .metal-logo { width: 24px; height: 24px; border-radius: 50%; }
    .price-up { color: #16a34a; }
    .price-down { color: #dc2626; }
    .lang-btn { cursor: pointer; opacity: 0.6; transition: opacity 0.2s; border-radius: 3px; }
    .lang-btn:hover, .lang-btn.active { opacity: 1; box-shadow: 0 0 0 2px #4f46e5; }
    html[dir="rtl"] .asset-item label { margin-left: 0; margin-right: 0.5rem; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-5xl bg-white rounded-2xl shadow-2xl p-6 md:p-10">
    
    <div id="language-switcher" class="flex justify-center space-x-3 mb-6">
        <img src="https://flagcdn.com/w40/tr.png" class="lang-btn h-6 active" data-lang="tr" alt="TÃ¼rkÃ§e">
        <img src="https://flagcdn.com/w40/gb.png" class="lang-btn h-6" data-lang="en" alt="English">
        <img src="https://flagcdn.com/w40/de.png" class="lang-btn h-6" data-lang="de" alt="Deutsch">
        <img src="https://flagcdn.com/w40/fr.png" class="lang-btn h-6" data-lang="fr" alt="FranÃ§ais">
        <img src="https://flagcdn.com/w40/cn.png" class="lang-btn h-6" data-lang="zh" alt="ä¸­æ–‡">
        <img src="https://flagcdn.com/w40/jp.png" class="lang-btn h-6" data-lang="ja" alt="æ—¥æœ¬èª">
        <img src="https://flagcdn.com/w40/kr.png" class="lang-btn h-6" data-lang="ko" alt="í•œêµ­ì–´">
        <img src="https://flagcdn.com/w40/sa.png" class="lang-btn h-6" data-lang="ar" alt="Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">
    </div>

    <div class="mb-8 p-4 border rounded-xl bg-gray-50">
      <h2 class="text-lg font-bold text-gray-800 mb-4 text-center md:text-left" data-translate-key="marketDataTitle">Piyasa Verileri</h2>
      <div id="market-widget-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
        <div class="text-center animate-pulse col-span-full" data-translate-key="loading">YÃ¼kleniyor...</div>
      </div>
    </div>

    <div class="text-center mb-6">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800" data-translate-key="mainTitle">YatÄ±rÄ±m Getirisi HesaplayÄ±cÄ±</h1>
      <p class="text-gray-500 mt-2" data-translate-key="subtitle">Kripto, dÃ¶viz ve faiz getirisi karÅŸÄ±laÅŸtÄ±rma aracÄ±.</p>
    </div>

    <form id="calculator-form" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label for="amount" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="investmentAmount">YatÄ±rÄ±m MiktarÄ± (TL)</label>
          <input type="number" id="amount" min="1" required placeholder="Ã–rn: 10000" class="w-full p-3 border border-gray-300 rounded-lg" />
        </div>
        <div>
          <label for="months" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="duration">SÃ¼re (Ay)</label>
          <input type="number" id="months" min="1" value="12" required placeholder="Ã–rn: 12" class="w-full p-3 border border-gray-300 rounded-lg" />
        </div>
        <div>
          <label for="base-date" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="endDate">BitiÅŸ Tarihi</label>
          <input type="date" id="base-date" class="w-full p-3 border border-gray-300 rounded-lg" />
          <p class="text-xs text-gray-400 mt-1" data-translate-key="endDateDefault">VarsayÄ±lan: bugÃ¼n</p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label for="annual-rate" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="interestRate">YÄ±llÄ±k Faiz OranÄ± (%)</label>
          <input type="number" step="0.01" id="annual-rate" placeholder="Ã–rn: 52.5" class="w-full p-3 border border-gray-300 rounded-lg" />
        </div>
        <div class="flex items-end">
          <label class="inline-flex items-center">
            <input id="include-interest" type="checkbox" class="mr-2 h-4 w-4 custom-checkbox appearance-none border-2 border-gray-300 rounded"/>
            <span class="text-sm text-gray-700" data-translate-key="includeInterest">Faizi Hesaplamaya Dahil Et</span>
          </label>
        </div>
        <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700" data-translate-key="assetSearch">VarlÄ±k Arama</label>
            <div class="flex items-center gap-2">
                <input type="search" id="asset-search" placeholder="VarlÄ±k ara..." class="w-full p-2 border border-gray-300 rounded-lg text-sm" data-translate-key="searchPlaceholder">
            </div>
        </div>
      </div>
      
      <div class="flex justify-end">
         <label class="flex items-center text-sm"><input type="checkbox" id="select-all-global" class="mr-1 custom-checkbox appearance-none border-2 border-gray-300 rounded"><span data-translate-key="selectAllGlobal">Hepsini SeÃ§</span></label>
      </div>

      <!-- VarlÄ±k SeÃ§im KutucuklarÄ± -->
      <div id="asset-panels" class="space-y-6">
        <!-- DÃ¶viz BÃ¶lÃ¼mÃ¼ -->
        <div class="p-4 border rounded-lg bg-gray-50 asset-category-panel">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold text-gray-800" data-translate-key="forex">DÃ¶viz</h3>
                <label class="flex items-center text-sm"><input type="checkbox" class="select-all-tab mr-1 custom-checkbox appearance-none border-2 border-gray-300 rounded"><span data-translate-key="selectAll">TÃ¼mÃ¼nÃ¼ SeÃ§</span></label>
            </div>
            <div id="currency-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
            <button type="button" id="show-more-assets" class="text-indigo-600 text-sm font-semibold mt-3 w-full text-center hover:text-indigo-500" data-translate-key="showMore"> + Daha Fazla GÃ¶ster</button>
        </div>
        <!-- Borsa Ä°stanbul BÃ¶lÃ¼mÃ¼ -->
        <div class="p-4 border rounded-lg bg-gray-50 asset-category-panel">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold text-gray-800" data-translate-key="bist">Borsa Ä°stanbul</h3>
                <label class="flex items-center text-sm"><input type="checkbox" class="select-all-tab mr-1 custom-checkbox appearance-none border-2 border-gray-300 rounded"><span data-translate-key="selectAll">TÃ¼mÃ¼nÃ¼ SeÃ§</span></label>
            </div>
            <div id="stock-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                 <div class="text-center animate-pulse col-span-full">BÄ°ST varlÄ±k listesi yÃ¼kleniyor...</div>
            </div>
        </div>
        <!-- Kripto Para BÃ¶lÃ¼mÃ¼ -->
        <div class="p-4 border rounded-lg bg-gray-50 asset-category-panel">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold text-gray-800" data-translate-key="crypto">Kripto Para & AltÄ±n</h3>
                <label class="flex items-center text-sm"><input type="checkbox" class="select-all-tab mr-1 custom-checkbox appearance-none border-2 border-gray-300 rounded"><span data-translate-key="selectAll">TÃ¼mÃ¼nÃ¼ SeÃ§</span></label>
            </div>
            <div id="crypto-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                 <div class="text-center animate-pulse col-span-full">Kripto varlÄ±k listesi yÃ¼kleniyor...</div>
            </div>
        </div>
      </div>

      <button type="submit" id="calculate-btn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg flex items-center justify-center transition hover:bg-indigo-700">
        <span id="btn-text" data-translate-key="calculate">Hesapla</span>
        <div id="btn-loader" class="loader hidden ml-2"></div>
      </button>
    </form>

    <!-- SonuÃ§lar ve Hata ModalÄ± -->
    <div id="results-section" class="hidden mt-8">
      <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg mb-4">
        <p class="font-bold" data-translate-key="dataSourceTitle">Veri KaynaÄŸÄ± Bilgisi</p>
        <p data-translate-key="dataSourceDesc">AnlÄ±k veriler API'lerden, geÃ§miÅŸ veriler ise sizin yÃ¶nettiÄŸiniz Firestore veritabanÄ±ndan alÄ±nÄ±r. GeÃ§miÅŸ veri bulunamazsa, API'den en yakÄ±n tarihli veri kullanÄ±lÄ±r.</p>
      </div>
      <h2 id="date-range" class="text-xl font-semibold text-gray-700 text-center mb-4"></h2>
      <div class="grid grid-cols-1 gap-6">
        <div class="overflow-x-auto bg-white rounded-lg shadow-md p-4">
          <table class="min-w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase" data-translate-key="tableAsset">VarlÄ±k</th>
                <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase" data-translate-key="tableReturn">Getiri (%)</th>
                <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase" data-translate-key="tableProfit">Kar/Zarar (â‚º)</th>
                <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase" data-translate-key="tableStartPrice">BaÅŸlangÄ±Ã§ F. (â‚º)</th>
                <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase" data-translate-key="tableEndPrice">BitiÅŸ F. (â‚º)</th>
              </tr>
            </thead>
            <tbody id="results-table-body" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-4 rounded-lg shadow-md">
                <div class="chart-container"><canvas id="results-chart"></canvas></div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md">
                <div class="chart-container"><canvas id="pie-chart"></canvas></div>
            </div>
        </div>
      </div>
    </div>
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
      <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
        <h3 class="text-lg font-bold text-red-600 mb-4" data-translate-key="errorTitle">Hata</h3>
        <p id="error-message" class="text-gray-700 mb-6"></p>
        <button id="close-modal-btn" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600" data-translate-key="close">Kapat</button>
      </div>
    </div>
    <!-- Yasal UyarÄ± ModalÄ± -->
    <div id="disclaimer-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
      <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
        <h3 class="text-lg font-bold text-amber-600 mb-4" data-translate-key="disclaimerTitle">DÄ°KKAT: GEÃ‡MÄ°Å PERFORMANS GELECEÄÄ°N GÃ–STERGESÄ° DEÄÄ°LDÄ°R</h3>
        <div class="text-sm text-gray-700 space-y-2" data-translate-key="disclaimerText">
            <p>Bu araÃ§, yalnÄ±zca <strong>geÃ§miÅŸ dÃ¶nemlerdeki</strong> yatÄ±rÄ±m getirilerini simÃ¼le eder. GÃ¶sterilen sonuÃ§lar:</p>
            <ol class="list-decimal list-inside space-y-1 pl-2">
                <li>Gelecekteki kazanÃ§ garantisi veya tavsiyesi <strong>deÄŸildir</strong>,</li>
                <li>Piyasa riski, enflasyon, dÃ¼zenleyici deÄŸiÅŸiklikler vb. faktÃ¶rleri iÃ§ermez,</li>
                <li>Komisyon, vergi veya iÅŸlem maliyetlerini hesaba katmaz.</li>
            </ol>
            <p>Kripto paralar, emtialar ve dÃ¶viz piyasalarÄ± <strong>yÃ¼ksek volatilite</strong> iÃ§erir. GeÃ§miÅŸ performans, gelecek sonuÃ§larÄ±n gÃ¼venilir bir Ã¶ngÃ¶rÃ¼sÃ¼ deÄŸildir. Bu araÃ§la elde edilen bilgiler <strong>kiÅŸisel yatÄ±rÄ±m danÄ±ÅŸmanlÄ±ÄŸÄ±</strong> yerine geÃ§mez. YatÄ±rÄ±m kararlarÄ±nÄ±z Ã¶ncesinde lÃ¼tfen baÄŸÄ±msÄ±z bir finansal danÄ±ÅŸmana ve gÃ¼ncel resmi kaynaklara baÅŸvurun.</p>
            <p>Hesaplama yaparak, bu uyarÄ±larÄ± okuduÄŸunuzu ve yatÄ±rÄ±m risklerini tamamen kendi sorumluluÄŸunuzda Ã¼stlendiÄŸinizi kabul etmiÅŸ olursunuz.</p>
        </div>
        <div class="flex justify-end space-x-4 mt-6">
            <button id="decline-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600" data-translate-key="decline">Kabul Etmiyorum</button>
            <button id="accept-btn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700" data-translate-key="accept">Kabul Ediyorum</button>
        </div>
      </div>
    </div>
  </div>

<script type="module">
    // Firebase SDK'larÄ±
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const FRANKFURTER_API_URL = 'https://api.frankfurter.app';
    const COINGECKO_API_URL = 'https://api.coingecko.com/api/v3';

    // --- VERÄ° KAYNAKLARI ---
    let DYNAMIC_CRYPTO_INFO = {}; 
    let DYNAMIC_STOCK_INFO = {}; 
    const CURRENCY_TRANSLATIONS = {
        "Australian Dollar": "Avustralya DolarÄ±", "Bulgarian Lev": "Bulgar LevasÄ±", "Brazilian Real": "Brezilya Reali",
        "Canadian Dollar": "Kanada DolarÄ±", "Swiss Franc": "Ä°sviÃ§re FrangÄ±", "Chinese Yuan Renminbi": "Ã‡in YuanÄ±",
        "Czech Koruna": "Ã‡ek KorunasÄ±", "Danish Krone": "Danimarka Kronu", "Euro": "Euro", "British Pound": "Ä°ngiliz Sterlini",
        "Hong Kong Dollar": "Hong Kong DolarÄ±", "Croatian Kuna": "HÄ±rvat KunasÄ±", "Hungarian Forint": "Macar Forinti",
        "Indonesian Rupiah": "Endonezya Rupisi", "Israeli Shekel": "Ä°srail Åekeli", "Indian Rupee": "Hindistan Rupisi",
        "Icelandic Krona": "Ä°zlanda Kronu", "Japanese Yen": "Japon Yeni", "South Korean Won": "GÃ¼ney Kore Wonu",
        "Mexican Peso": "Meksika Pesosu", "Malaysian Ringgit": "Malezya Ringgiti", "Norwegian Krone": "NorveÃ§ Kronu",
        "New Zealand Dollar": "Yeni Zelanda DolarÄ±", "Philippine Peso": "Filipin Pesosu", "Polish Zloty": "Polonya Zlotisi",
        "Romanian Leu": "Rumen Leyi", "Russian Rouble": "Rus Rublesi", "Swedish Krona": "Ä°sveÃ§ Kronu",
        "Singapore Dollar": "Singapur DolarÄ±", "Thai Baht": "Tayland BahtÄ±", "Turkish Lira": "TÃ¼rk LirasÄ±",
        "US Dollar": "Amerikan DolarÄ±", "South African Rand": "GÃ¼ney Afrika RandÄ±",
        "United Arab Emirates Dirham": "BAE Dirhemi", "Saudi Riyal": "Suudi Arabistan Riyali"
    };
    let CURRENCY_INFO = {};
    let ALL_ASSETS_INFO = {};
    let currentLang = 'tr';
    let db; // Firestore instance

    // DOM Elementleri
    const form = document.getElementById('calculator-form');
    const marketWidgetContainer = document.getElementById('market-widget-container');
    const assetSearchInput = document.getElementById('asset-search');
    const showMoreBtn = document.getElementById('show-more-assets');
    const amountInput = document.getElementById('amount');
    const monthsInput = document.getElementById('months');
    const calculateBtn = document.getElementById('calculate-btn');
    const btnText = document.getElementById('btn-text');
    const btnLoader = document.getElementById('btn-loader');
    const resultsSection = document.getElementById('results-section');
    const dateRangeDisplay = document.getElementById('date-range');
    const tableBody = document.getElementById('results-table-body');
    const chartCanvas = document.getElementById('results-chart');
    const pieChartCanvas = document.getElementById('pie-chart');
    const errorModal = document.getElementById('error-modal');
    const errorMessage = document.getElementById('error-message');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const baseDateInput = document.getElementById('base-date');
    const annualRateInput = document.getElementById('annual-rate');
    const includeInterestCheckbox = document.getElementById('include-interest');
    const assetPanels = document.getElementById('asset-panels');
    const languageSwitcher = document.getElementById('language-switcher');
    const selectAllGlobalCheckbox = document.getElementById('select-all-global');
    const disclaimerModal = document.getElementById('disclaimer-modal');
    const acceptBtn = document.getElementById('accept-btn');
    const declineBtn = document.getElementById('decline-btn');

    let myChart = null;
    let myPieChart = null;

    // --- Ã‡OKLU DÄ°L DESTEÄÄ° ---
    const translations = {
        mainTitle: { tr: 'YatÄ±rÄ±m Getirisi HesaplayÄ±cÄ±', en: 'Investment Return Calculator' },
        subtitle: { tr: 'Kripto, Borsa, dÃ¶viz ve faiz getirisi karÅŸÄ±laÅŸtÄ±rma aracÄ±.', en: 'Crypto, Stock, forex, and interest return comparison tool.'},
        marketDataTitle: { tr: 'Piyasa Verileri', en: 'Market Data' },
        investmentAmount: { tr: 'YatÄ±rÄ±m MiktarÄ± (TL)', en: 'Investment Amount (TRY)' },
        duration: { tr: 'SÃ¼re (Ay)', en: 'Duration (Months)' },
        endDate: { tr: 'BitiÅŸ Tarihi', en: 'End Date' },
        endDateDefault: { tr: 'VarsayÄ±lan: bugÃ¼n', en: 'Default: today' },
        interestRate: { tr: 'YÄ±llÄ±k Faiz OranÄ± (%)', en: 'Annual Interest Rate (%)' },
        includeInterest: { tr: 'Faizi Hesaplamaya Dahil Et', en: 'Include Interest in Calculation' },
        assetSearch: { tr: 'VarlÄ±k Arama', en: 'Asset Search' },
        searchPlaceholder: { tr: 'VarlÄ±k ara...', en: 'Search for asset...' },
        selectAllGlobal: { tr: 'Hepsini SeÃ§', en: 'Select All' },
        forex: { tr: 'DÃ¶viz', en: 'Forex' },
        bist: { tr: 'Borsa Ä°stanbul', en: 'Borsa Istanbul' },
        crypto: { tr: 'Kripto Para & AltÄ±n', en: 'Cryptocurrency & Gold' },
        selectAll: { tr: 'TÃ¼mÃ¼nÃ¼ SeÃ§', en: 'Select All' },
        showMore: { tr: '+ Daha Fazla GÃ¶ster', en: '+ Show More' },
        calculate: { tr: 'Hesapla', en: 'Calculate' },
        dataSourceTitle: { tr: 'Veri KaynaÄŸÄ± Bilgisi', en: 'Data Source Information' },
        dataSourceDesc: { tr: "AnlÄ±k veriler API'lerden, geÃ§miÅŸ veriler ise sizin yÃ¶nettiÄŸiniz Firestore veritabanÄ±ndan alÄ±nÄ±r. GeÃ§miÅŸ veri bulunamazsa, API'den en yakÄ±n tarihli veri kullanÄ±lÄ±r.", en: "Live data is fetched from APIs, while historical data is taken from the Firestore database you manage. If historical data isn't found, the closest available data from the API is used." },
        tableAsset: { tr: 'VarlÄ±k', en: 'Asset' },
        tableReturn: { tr: 'Getiri (%)', en: 'Return (%)' },
        tableProfit: { tr: 'Kar/Zarar (â‚º)', en: 'Profit/Loss (TRY)' },
        tableStartPrice: { tr: 'BaÅŸlangÄ±Ã§ F. (â‚º)', en: 'Start Price (TRY)' },
        tableEndPrice: { tr: 'BitiÅŸ F. (â‚º)', en: 'End Price (TRY)' },
        errorTitle: { tr: 'Hata', en: 'Error' },
        close: { tr: 'Kapat', en: 'Close' },
        loading: { tr: 'YÃ¼kleniyor...', en: 'Loading...' },
        monthsReturn: { tr: 'AylÄ±k Getiri', en: 'Month Return' },
        'asset_tether-gold': { tr: 'Tether Gold (AltÄ±n)', en: 'Tether Gold' },
        disclaimerTitle: { tr: "DÄ°KKAT: GEÃ‡MÄ°Å PERFORMANS GELECEÄÄ°N GÃ–STERGESÄ° DEÄÄ°LDÄ°R", en: "ATTENTION: PAST PERFORMANCE IS NOT INDICATIVE OF FUTURE RESULTS" },
        disclaimerText: { tr: `<p>Bu araÃ§, yalnÄ±zca <strong>geÃ§miÅŸ dÃ¶nemlerdeki</strong> yatÄ±rÄ±m getirilerini simÃ¼le eder. GÃ¶sterilen sonuÃ§lar:</p><ol class="list-decimal list-inside space-y-1 pl-2"><li>Gelecekteki kazanÃ§ garantisi veya tavsiyesi <strong>deÄŸildir</strong>,</li><li>Piyasa riski, enflasyon, dÃ¼zenleyici deÄŸiÅŸiklikler vb. faktÃ¶rleri iÃ§ermez,</li><li>Komisyon, vergi veya iÅŸlem maliyetlerini hesaba katmaz.</li></ol><p>Kripto paralar, emtialar ve dÃ¶viz piyasalarÄ± <strong>yÃ¼ksek volatilite</strong> iÃ§erir. GeÃ§miÅŸ performans, gelecek sonuÃ§larÄ±n gÃ¼venilir bir Ã¶ngÃ¶rÃ¼sÃ¼ deÄŸildir. Bu araÃ§la elde edilen bilgiler <strong>kiÅŸisel yatÄ±rÄ±m danÄ±ÅŸmanlÄ±ÄŸÄ±</strong> yerine geÃ§mez. YatÄ±rÄ±m kararlarÄ±nÄ±z Ã¶ncesinde lÃ¼tfen baÄŸÄ±msÄ±z bir finansal danÄ±ÅŸmana ve gÃ¼ncel resmi kaynaklara baÅŸvurun.</p><p>Hesaplama yaparak, bu uyarÄ±larÄ± okuduÄŸunuzu ve yatÄ±rÄ±m risklerini tamamen kendi sorumluluÄŸunuzda Ã¼stlendiÄŸinizi kabul etmiÅŸ olursunuz.</p>`, en: `<p>This tool only simulates investment returns from <strong>past periods</strong>. The results shown:</p><ol class="list-decimal list-inside space-y-1 pl-2"><li>Are <strong>not</strong> a guarantee or recommendation of future earnings,</li><li>Do not include factors such as market risk, inflation, regulatory changes, etc.,</li><li>Do not account for commissions, taxes, or transaction costs.</li></ol><p>Cryptocurrencies, commodities, and foreign exchange markets involve <strong>high volatility</strong>. Past performance is not a reliable predictor of future results. The information obtained with this tool does <strong>not</strong> substitute for <strong>personal investment advice</strong>. Please consult an independent financial advisor and current official sources before making investment decisions.</p><p>By calculating, you have read these warnings and assume all investment risks at your own responsibility.</p>` },
        accept: { tr: 'Kabul Ediyorum', en: 'I Agree' },
        decline: { tr: 'Kabul Etmiyorum', en: 'I Decline' },
    };

    function getTranslation(key, fallback = '') {
        const lowerKey = key?.toLowerCase() || '';
        if (lowerKey.startsWith('currency_')) {
            const code = lowerKey.replace('currency_', '').toUpperCase();
            const englishName = CURRENCY_INFO[code]?.name || fallback;
            return CURRENCY_TRANSLATIONS[englishName] || englishName;
        }
        if (translations[key]) return translations[key][currentLang] || fallback;

        const assetKey = 'asset_' + lowerKey;
        if(translations[assetKey]) return translations[assetKey][currentLang] || fallback;
        
        return fallback;
    }

    function changeLanguage(lang) {
        currentLang = lang;
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

        document.querySelectorAll('[data-translate-key]').forEach(el => {
            const key = el.dataset.translateKey;
            let fallback = el.tagName === 'INPUT' ? el.placeholder : el.textContent;
            const translation = getTranslation(key, fallback);

            if (el.tagName === 'INPUT') {
                el.placeholder = translation;
            } else {
                const firstChild = el.firstChild;
                if (firstChild && firstChild.nodeType === Node.TEXT_NODE) {
                    firstChild.nodeValue = translation;
                } else {
                    el.textContent = translation;
                }
            }
        });
        
        languageSwitcher.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.lang === lang);
        });
        rebuildAssetLists();
    }

    // --- BAÅLANGIÃ‡ FONKSÄ°YONLARI ---
    async function setupFirebase() {
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyCTYoVO0ItXIqeR16oDNgDVkbw-nbVLePE",
                authDomain: "yatirim-hesaplayici.firebaseapp.com",
                projectId: "yatirim-hesaplayici",
                storageBucket: "yatirim-hesaplayici.appspot.com",
                messagingSenderId: "859286610441",
                appId: "1:859286610441:web:1b09fc6b0ce1665fd9ced8"
            };
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase initialized.");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showError("VeritabanÄ± baÄŸlantÄ±sÄ± kurulamadÄ±. LÃ¼tfen sayfayÄ± yenileyin.");
        }
    }
    
    async function fetchAssetConfig(configName) {
        if (!db) return {};
        try {
            const configDocRef = doc(db, "config", configName);
            const docSnap = await getDoc(configDocRef);
            if (docSnap.exists()) {
                const config = docSnap.data();
                if (configName === 'supported_cryptos') {
                    const ids = Object.keys(config).join(',');
                    if (!ids) return config;
                    const markets = await fetch(`${COINGECKO_API_URL}/coins/markets?vs_currency=try&ids=${ids}&order=market_cap_desc&per_page=100&page=1&sparkline=false`);
                    const marketsData = await markets.json();
                    marketsData.forEach(market => {
                        if(config[market.id]) { config[market.id].logo = market.image; }
                    });
                }
                return config;
            } else {
                console.error(`${configName} document does not exist in Firestore!`);
                return {};
            }
        } catch (error) {
            console.error(`Error fetching ${configName} config:`, error);
            return {};
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await setupFirebase();
      [DYNAMIC_CRYPTO_INFO, DYNAMIC_STOCK_INFO] = await Promise.all([
          fetchAssetConfig('supported_cryptos'),
          fetchAssetConfig('supported_stocks')
      ]);

      if(Object.keys(DYNAMIC_CRYPTO_INFO).length === 0) {
          document.getElementById('crypto-list').innerHTML = `<div class="col-span-full text-center text-red-500">Kripto varlÄ±k listesi yÃ¼klenemedi.</div>`;
      }
       if(Object.keys(DYNAMIC_STOCK_INFO).length === 0) {
          document.getElementById('stock-list').innerHTML = `<div class="col-span-full text-center text-red-500">BÄ°ST varlÄ±k listesi yÃ¼klenemedi.</div>`;
      }
      
      await initializeAssetSelectors();
      await updateMarketWidget();
      baseDateInput.value = new Date().toISOString().split('T')[0];
      changeLanguage(currentLang);
    });

    async function initializeAssetSelectors() {
        try {
            const res = await fetch(`${FRANKFURTER_API_URL}/currencies`);
            const currencies = await res.json();
            const currencyToCountryCodeMap = { 'SAR': 'sa', 'AED': 'ae', 'TRY': 'tr', 'GBP': 'gb', 'USD': 'us', 'EUR': 'eu', 'JPY': 'jp', 'CHF': 'ch', 'CNY': 'cn', 'KRW': 'kr' };
            for(const code in currencies){
                const englishName = currencies[code];
                const countryCode = currencyToCountryCodeMap[code] || code.substring(0, 2).toLowerCase();
                CURRENCY_INFO[code] = { 
                    name: englishName, 
                    logo: `https://flagcdn.com/w40/${countryCode}.png` 
                };
            }
            
            ALL_ASSETS_INFO = {
                ...CURRENCY_INFO,
                ...DYNAMIC_CRYPTO_INFO,
                ...DYNAMIC_STOCK_INFO
            };
            
            rebuildAssetLists();

        } catch (error) {
            showError("VarlÄ±k listesi yÃ¼klenemedi. LÃ¼tfen sayfayÄ± yenileyin.");
        }
    }
    
    function rebuildAssetLists() {
        const currencyList = document.getElementById('currency-list');
        const cryptoList = document.getElementById('crypto-list');
        const stockList = document.getElementById('stock-list');
        
        currencyList.innerHTML = '';
        cryptoList.innerHTML = '';
        stockList.innerHTML = '';

        const popularCurrencies = ['USD', 'EUR', 'GBP', 'CHF', 'CAD', 'AUD', 'JPY', 'SAR', 'AED'];
        Object.keys(CURRENCY_INFO).sort().forEach(code => {
            const info = CURRENCY_INFO[code];
            const translatedName = getTranslation('currency_' + code, info.name);
            const isHidden = !popularCurrencies.includes(code) ? 'hidden' : '';
            currencyList.innerHTML += createAssetCheckboxHTML(code, translatedName, info.logo, 'asset-logo', ['USD', 'EUR'].includes(code), isHidden);
        });

        const sortedCryptoIds = Object.keys(DYNAMIC_CRYPTO_INFO).sort((a,b) => DYNAMIC_CRYPTO_INFO[a].name.localeCompare(DYNAMIC_CRYPTO_INFO[b].name));
        sortedCryptoIds.forEach(id => {
            const info = DYNAMIC_CRYPTO_INFO[id];
            cryptoList.innerHTML += createAssetCheckboxHTML(id, info.name, info.logo, 'crypto-logo', ['bitcoin', 'tether-gold', 'solana', 'ripple', 'cardano'].includes(id));
        });

        const sortedStockIds = Object.keys(DYNAMIC_STOCK_INFO).sort((a,b) => DYNAMIC_STOCK_INFO[a].name.localeCompare(DYNAMIC_STOCK_INFO[b].name));
        sortedStockIds.forEach(id => {
            const info = DYNAMIC_STOCK_INFO[id];
            stockList.innerHTML += createAssetCheckboxHTML(id, info.name, 'https://placehold.co/24x24/1D4ED8/FFFFFF?text='+id[0], 'crypto-logo', ['THYAO', 'TUPRS'].includes(id));
        });
    }

    function createAssetCheckboxHTML(id, name, logo, logoClass, isChecked = false, isHidden = '') {
        const assetInfo = ALL_ASSETS_INFO[id];
        if (!assetInfo) return ''; 
        return `
            <div class="flex items-center asset-item ${isHidden}" data-name="${name.toLowerCase()} ${id.toLowerCase()}">
                <input id="asset-${id}" type="checkbox" value="${id}" ${isChecked ? 'checked' : ''} class="custom-checkbox appearance-none h-5 w-5 border-2 border-gray-300 rounded cursor-pointer">
                <label for="asset-${id}" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer flex items-center" title="${id.toUpperCase()}">
                    <img src="${logo || 'https://placehold.co/24x24/e0e0e0/e0e0e0'}" alt="${name}" class="${logoClass} mr-2" onerror="this.onerror=null;this.src='https://placehold.co/24x24/e0e0e0/000000?text=?';">
                    <span>${assetInfo.symbol || id.toUpperCase()}</span>
                </label>
            </div>
        `;
    }

    async function updateMarketWidget() {
        try {
            const cryptoIds = 'bitcoin,ethereum,tether-gold,solana,ripple,cardano'; 

            const [todayFX, cryptoData] = await Promise.all([
                fetch(`${FRANKFURTER_API_URL}/latest?from=USD&to=TRY,EUR`).then(res => res.json()),
                fetch(`${COINGECKO_API_URL}/simple/price?ids=${cryptoIds}&vs_currencies=try&include_24hr_change=true`).then(res => res.json())
            ]);

            const todayUSDtoTRY = todayFX.rates.TRY;
            const todayEURtoTRY = (1 / todayFX.rates.EUR) * todayUSDtoTRY;
            
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            const yesterdayFX = await fetch(`${FRANKFURTER_API_URL}/${yesterdayStr}?from=USD&to=TRY,EUR`).then(res => res.json());
            const yesterdayUSDtoTRY = yesterdayFX.rates.TRY;
            const yesterdayEURtoTRY = (1 / yesterdayFX.rates.EUR) * yesterdayUSDtoTRY;


            const widgetData = [
                { id: 'USD', name: 'Dolar', logo: CURRENCY_INFO.USD.logo, today: todayUSDtoTRY, changePercent: ((todayUSDtoTRY - yesterdayUSDtoTRY) / yesterdayUSDtoTRY) * 100 },
                { id: 'EUR', name: 'Euro', logo: CURRENCY_INFO.EUR.logo, today: todayEURtoTRY, changePercent: ((todayEURtoTRY - yesterdayEURtoTRY) / yesterdayEURtoTRY) * 100 },
                { id: 'tether-gold', name: 'Tether Gold', logo: DYNAMIC_CRYPTO_INFO['tether-gold']?.logo, today: cryptoData['tether-gold']?.try, changePercent: cryptoData['tether-gold']?.try_24h_change },
                { id: 'bitcoin', name: 'Bitcoin', logo: DYNAMIC_CRYPTO_INFO.bitcoin?.logo, today: cryptoData.bitcoin?.try, changePercent: cryptoData.bitcoin?.try_24h_change },
                { id: 'ethereum', name: 'Ethereum', logo: DYNAMIC_CRYPTO_INFO.ethereum?.logo, today: cryptoData.ethereum?.try, changePercent: cryptoData.ethereum?.try_24h_change },
                { id: 'solana', name: 'Solana', logo: DYNAMIC_CRYPTO_INFO.solana?.logo, today: cryptoData.solana?.try, changePercent: cryptoData.solana?.try_24h_change },
            ].filter(item => item.today !== undefined); 

            marketWidgetContainer.innerHTML = '';
            widgetData.forEach(item => {
                const changePercent = item.changePercent || 0;
                const change = item.today / (1 + changePercent / 100) * (changePercent / 100);
                const changeClass = changePercent >= 0 ? 'price-up' : 'price-down';
                const sign = changePercent >= 0 ? '+' : '';

                marketWidgetContainer.innerHTML += `
                    <div class="flex flex-col items-center p-3 bg-white rounded-lg shadow-sm border">
                        <div class="flex items-center font-bold text-gray-800 text-center text-sm h-10">
                           <img src="${item.logo || 'https://placehold.co/24x24/e0e0e0/e0e0e0'}" alt="${item.name}" class="crypto-logo mr-2" onerror="this.style.display='none'">
                           <span>${item.name}</span>
                        </div>
                        <p class="text-lg font-semibold text-gray-900 my-1">${item.today.toLocaleString('tr-TR', {style:'currency', currency:'TRY', maximumFractionDigits: 2})}</p>
                        <div class="flex items-center text-xs font-medium ${changeClass}">
                           <span>${sign}${change.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚º</span>
                           <span class="mx-1">|</span>
                           <span>${sign}${changePercent.toFixed(2)}%</span>
                        </div>
                    </div>
                `;
            });

        } catch (error) {
            marketWidgetContainer.innerHTML = `<div class="col-span-full text-center text-red-500">Piyasa verileri yÃ¼klenemedi: ${error.message}</div>`;
        }
    }

    // --- HESAPLAMA FONKSÄ°YONLARI ---
    async function calculateAndDisplayResults() {
        setLoadingState(true);
        try {
            const amount = parseFloat(amountInput.value);
            const months = parseInt(monthsInput.value, 10);
            const selectedAssets = Array.from(document.querySelectorAll('#asset-panels input:checked')).map(el => el.value);
            const endDate = baseDateInput.value ? new Date(baseDateInput.value + 'T00:00:00') : new Date();
            const startDate = computeStartDate(endDate, months);
            
            const selectedCurrencies = selectedAssets.filter(a => CURRENCY_INFO[a]);
            const selectedCryptos = selectedAssets.filter(a => DYNAMIC_CRYPTO_INFO[a]);
            const selectedStocks = selectedAssets.filter(a => DYNAMIC_STOCK_INFO[a]);

            const [endCurrencyRates, startCurrencyRates, endCryptoRates, startCryptoRates, endStockRates, startStockRates] = await Promise.all([
                fetchCurrencyRates(formatDateForAPI(endDate), selectedCurrencies),
                fetchCurrencyRates(formatDateForAPI(startDate), selectedCurrencies),
                fetchHistoricalRates(endDate, selectedCryptos, 'crypto'),
                fetchHistoricalRates(startDate, selectedCryptos, 'crypto'),
                fetchHistoricalRates(endDate, selectedStocks, 'stock'),
                fetchHistoricalRates(startDate, selectedStocks, 'stock'),
            ]);
            
            const startRates = { ...startCurrencyRates, ...startCryptoRates, ...startStockRates };
            const endRates = { ...endCurrencyRates, ...endCryptoRates, ...endStockRates };

            const resultsData = processData(amount, startRates, endRates, selectedAssets);

            if (includeInterestCheckbox.checked) {
              const annualRate = parseFloat(annualRateInput.value);
              if (isNaN(annualRate) || annualRate <= 0) throw new Error(getTranslation('errorInvalidInterest', "GeÃ§erli bir faiz oranÄ± girin."));
              const monthlyRate = Math.pow(1 + annualRate / 100, 1/12) - 1;
              const finalValueGross = amount * Math.pow(1 + monthlyRate, months);
              const grossProfit = finalValueGross - amount;
              const stopajRate = getStopajRate(months);
              const netProfit = grossProfit * (1 - stopajRate);
              resultsData.push({
                name: `Faiz (${annualRate.toFixed(2)}%)`,
                profitLossTL: netProfit,
                profitLossPercent: (netProfit / amount) * 100,
              });
            }

            resultsData.sort((a, b) => b.profitLossPercent - a.profitLossPercent);
            
            dateRangeDisplay.textContent = `${months} ${getTranslation('monthsReturn', 'AylÄ±k Getiri')} (${formatDateForDisplay(startDate)} - ${formatDateForDisplay(endDate)})`;
            displayTable(resultsData);
            displayChart(resultsData);
            displayPieChart(resultsData);
            resultsSection.classList.remove('hidden');
        } catch (err) {
            showError(err.message);
        } finally {
            setLoadingState(false);
        }
    }
    
    async function fetchHistoricalRates(date, assetIds, assetType) {
        if (assetIds.length === 0) return {};
        const rates = {};
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const targetDate = new Date(date);
        targetDate.setHours(0, 0, 0, 0);
        const isToday = targetDate.getTime() >= today.getTime();

        if (isToday && assetType === 'crypto') {
            const ids = assetIds.join(',');
            const res = await fetch(`${COINGECKO_API_URL}/simple/price?ids=${ids}&vs_currencies=try`);
            if (!res.ok) throw new Error(`CanlÄ± kripto verileri alÄ±namadÄ± (API HatasÄ±: ${res.status})`);
            const data = await res.json();
            for (const id of assetIds) {
                if (data[id] && data[id].try) rates[id] = data[id].try;
            }
        } else {
            if (!db) throw new Error("VeritabanÄ± baÄŸlantÄ±sÄ± henÃ¼z hazÄ±r deÄŸil.");
            const collectionName = assetType === 'crypto' ? 'crypto_historical_prices' : 'stock_historical_prices';

            for (const id of assetIds) {
                const docRef = doc(db, collectionName, id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists() && docSnap.data().prices) {
                    const prices = docSnap.data().prices;
                    const closestDate = Object.keys(prices)
                        .map(d => new Date(d))
                        .filter(d => d <= targetDate)
                        .sort((a, b) => b - a)[0];
                    if (closestDate) {
                        rates[id] = prices[formatDateForAPI(closestDate)];
                    } else {
                        console.warn(`Firestore'da ${id} iÃ§in ${targetDate.toLocaleDateString()} Ã¶ncesine ait veri bulunamadÄ±.`);
                    }
                } else {
                     console.warn(`Firestore'da ${id} iÃ§in veri bulunamadÄ±.`);
                }
            }
        }

        const missingAssets = assetIds.filter(id => !rates[id]);
        if (missingAssets.length > 0) {
            const missingNames = missingAssets.map(id => ALL_ASSETS_INFO[id]?.name || id).join(', ');
            showError(`${missingNames} iÃ§in seÃ§ilen tarihlerde veri bulunamadÄ±. LÃ¼tfen yÃ¶netim panelinden veri ekleyin.`);
        }
        return rates;
    }

    async function fetchCurrencyRates(dateStr, currencies) {
        if (currencies.length === 0) return {};
        const toList = Array.from(new Set(['TRY', 'EUR', ...currencies])).join(',');
        const url = `${FRANKFURTER_API_URL}/${dateStr}?to=${toList}`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`API HatasÄ± (${dateStr}): ${resp.status}`);
        const data = await resp.json();
        if (!data.rates || !data.rates['TRY']) throw new Error(`SeÃ§ilen tarih (${dateStr}) iÃ§in TRY kuru bulunamadÄ±.`);
        const eurToTry = data.rates['TRY'];
        const ratesInTry = {};
        for (const k in data.rates) { ratesInTry[k] = eurToTry / data.rates[k]; }
        ratesInTry['EUR'] = eurToTry;
        return ratesInTry;
    }

    function processData(initialAmount, startRates, endRates, selectedAssets) {
        return selectedAssets
            .filter(asset => startRates[asset] && endRates[asset])
            .map(asset => {
                const startPrice = startRates[asset];
                const endPrice = endRates[asset];
                const profitLossTL = (initialAmount / startPrice) * endPrice - initialAmount;
                const profitLossPercent = (profitLossTL / initialAmount) * 100;
                return { name: asset, startPrice, endPrice, profitLossTL, profitLossPercent };
            });
    }

    // --- GÃ–RSELLEÅTÄ°RME FONKSÄ°YONLARI ---
    function displayTable(data) {
        tableBody.innerHTML = '';
        data.forEach((item, index) => {
            const isProfit = item.profitLossTL >= 0;
            const info = ALL_ASSETS_INFO[item.name] || { name: item.name };
            const isInterest = item.name.startsWith('Faiz');
            const logoHtml = info.logo ? `<img src="${info.logo}" alt="${info.name}" class="crypto-logo mr-2" onerror="this.onerror=null;this.src='https://placehold.co/24x24/e0e0e0/000000?text=?';">` : 
                (DYNAMIC_STOCK_INFO[item.name] ? `<img src="https://placehold.co/24x24/1D4ED8/FFFFFF?text=${item.name[0]}" alt="${info.name}" class="crypto-logo mr-2">` : '');
            
            const startPriceDisplay = isInterest || !item.startPrice ? '-' : item.startPrice.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 4 }) + 'â‚º';
            const endPriceDisplay = isInterest || !item.endPrice ? '-' : item.endPrice.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 4 }) + 'â‚º';

            const row = `
              <tr class="transition ${index === 0 && isProfit ? 'best-performer' : 'hover:bg-gray-50'}">
                <td class="py-3 px-4 font-semibold text-gray-800">
                  <div class="flex items-center">
                    ${logoHtml}
                    <span>${getTranslation(info.name, info.name)}</span>
                    ${index === 0 && isProfit ? '<span class="ml-auto text-xs bg-green-200 text-green-800 font-bold px-2 py-1 rounded-full">ğŸ† En Ä°yi</span>' : ''}
                  </div>
                </td>
                <td class="py-3 px-4 text-right font-semibold ${isProfit ? 'text-green-600' : 'text-red-600'}">${isProfit ? '+' : ''}${item.profitLossPercent.toFixed(2)}%</td>
                <td class="py-3 px-4 text-right font-semibold ${isProfit ? 'text-green-600' : 'text-red-600'}">${isProfit ? '+' : ''}${item.profitLossTL.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}â‚º</td>
                 <td class="py-3 px-4 text-right text-gray-600">${startPriceDisplay}</td>
                <td class="py-3 px-4 text-right text-gray-600">${endPriceDisplay}</td>
              </tr>`;
            tableBody.insertAdjacentHTML('beforeend', row);
        });
    }

    function displayChart(data){
      if (myChart) myChart.destroy();
      const labels = data.map(d => getTranslation(ALL_ASSETS_INFO[d.name]?.name || d.name, ALL_ASSETS_INFO[d.name]?.name || d.name));
      const profitLossData = data.map(d => Number(d.profitLossTL.toFixed(2)));
      const ctx = chartCanvas.getContext('2d');
      myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label:'Kar/Zarar (â‚º)', data:profitLossData, backgroundColor: profitLossData.map(v => v >= 0 ? 'rgba(34,197,94,0.85)' : 'rgba(239,68,68,0.85)'), borderRadius:6 }]
        },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display: false}, tooltip:{ callbacks:{ label: ctx => `Kar/Zarar: ${ctx.raw.toLocaleString('tr-TR', {style:'currency', currency:'TRY'})}` }}},
          scales:{ 
              y:{ ticks:{ callback: v => v.toLocaleString('tr-TR', {style:'currency', currency:'TRY'})}}, 
              x:{ grid:{ display:false } } 
          }
        }
      });
    }

    function displayPieChart(data) {
        if (myPieChart) myPieChart.destroy();
        const labels = data.map(d => getTranslation(ALL_ASSETS_INFO[d.name]?.name || d.name, ALL_ASSETS_INFO[d.name]?.name || d.name));
        const finalValues = data.map(d => Number((amountInput.valueAsNumber + d.profitLossTL).toFixed(2)));
        const ctx = pieChartCanvas.getContext('2d');
        myPieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels,
                datasets: [{
                    label: 'Vade Sonu DeÄŸer (â‚º)',
                    data: finalValues,
                    backgroundColor: [
                        'rgba(79, 70, 229, 0.8)', 'rgba(219, 39, 119, 0.8)', 'rgba(14, 165, 233, 0.8)',
                        'rgba(245, 158, 11, 0.8)', 'rgba(16, 185, 129, 0.8)', 'rgba(139, 92, 246, 0.8)',
                        'rgba(239, 68, 68, 0.8)', 'rgba(34, 197, 94, 0.8)', 'rgba(99, 102, 241, 0.8)',
                        'rgba(244, 63, 94, 0.8)', 'rgba(253, 186, 116, 0.8)', 'rgba(5, 150, 105, 0.8)'
                    ],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: 'Vade Sonu DeÄŸer DaÄŸÄ±lÄ±mÄ±' }
                }
            }
        });
    }

    // --- YARDIMCI FONKSÄ°YONLAR VE EVENT LISTENERS ---
    function getStopajRate(months) { if (months <= 6) return 0.05; if (months <= 12) return 0.03; return 0.00; }
    function computeStartDate(endDate, monthsBack){ const d = new Date(endDate); d.setMonth(d.getMonth() - monthsBack); return d; }
    function formatDateForAPI(date){ return date.toISOString().split('T')[0]; }
    function formatDateForDisplay(date){ return new Intl.DateTimeFormat(currentLang).format(date); }
    function showError(message){ errorMessage.textContent = message; errorModal.classList.remove('hidden'); }
    function setLoadingState(isLoading){ calculateBtn.disabled = isLoading; btnText.classList.toggle('hidden', isLoading); btnLoader.classList.toggle('hidden', !isLoading); }
    
    form.addEventListener('submit', e => { 
        e.preventDefault(); 
        const amount = parseFloat(amountInput.value);
        const months = parseInt(monthsInput.value, 10);
        const selectedAssets = Array.from(document.querySelectorAll('#asset-panels input:checked')).map(el => el.value);

        if (isNaN(amount) || amount <= 0) return showError(getTranslation('errorInvalidAmount', "GeÃ§erli bir yatÄ±rÄ±m miktarÄ± girin."));
        if (isNaN(months) || months <= 0) return showError(getTranslation('errorInvalidDuration', "GeÃ§erli bir sÃ¼re girin."));
        if (selectedAssets.length === 0 && !includeInterestCheckbox.checked) return showError(getTranslation('errorNoAssets', "LÃ¼tfen en az bir varlÄ±k seÃ§in veya faizi dahil edin."));
        
        disclaimerModal.classList.remove('hidden');
    });

    acceptBtn.addEventListener('click', () => {
        disclaimerModal.classList.add('hidden');
        calculateAndDisplayResults();
    });

    declineBtn.addEventListener('click', () => {
        disclaimerModal.classList.add('hidden');
    });

    closeModalBtn.addEventListener('click', () => errorModal.classList.add('hidden'));
    showMoreBtn.addEventListener('click', (e) => {
        document.querySelectorAll('#currency-list .asset-item.hidden').forEach(item => item.classList.remove('hidden'));
        e.target.style.display = 'none';
    });
    
    assetSearchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll('.asset-item').forEach(item => {
            item.style.display = item.dataset.name.includes(searchTerm) ? 'flex' : 'none';
        });
    });

    assetPanels.addEventListener('change', (e) => {
        if (e.target.classList.contains('select-all-tab')) {
            const isChecked = e.target.checked;
            const panel = e.target.closest('.asset-category-panel');
            panel.querySelectorAll('input[type="checkbox"]:not(.select-all-tab)').forEach(checkbox => checkbox.checked = isChecked);
        }
    });
    
    selectAllGlobalCheckbox.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        document.querySelectorAll('#asset-panels input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = isChecked;
        });
    });

    languageSwitcher.addEventListener('click', (e) => {
        if (e.target.dataset.lang) {
            changeLanguage(e.target.dataset.lang);
        }
    });

</script>
</body>
</html>

